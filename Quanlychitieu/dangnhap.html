<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÄÄƒng Nháº­p - QL NgÃ¢n Quá»¹</title>
    <link rel="stylesheet" href="auth.css">
</head>
<body>
    <div class="login-container">
        <div class="login-box">
            <div class="login-header">
                <div class="logo">ğŸ“Š</div>
                <h1>QL NgÃ¢n Quá»¹</h1>
                <p>Quáº£n lÃ½ chi tiÃªu cÃ¡ nhÃ¢n thÃ´ng minh</p>
            </div>

            <div id="loginMessage" style="display:none; margin: 0 0 14px; padding: 10px 12px; border-radius: 10px;"></div>

            <form id="loginForm" autocomplete="on">
                <div class="form-group">
                    <label for="tenDangNhap">TÃªn Ä‘Äƒng nháº­p</label>
                    <input
                        type="text"
                        id="tenDangNhap"
                        name="tenDangNhap"
                        placeholder="Nháº­p tÃªn Ä‘Äƒng nháº­p"
                        required
                        autocomplete="username"
                    >
                </div>

                <div class="form-group">
                    <label for="matKhau">Máº­t kháº©u</label>
                    <input
                        type="password"
                        id="matKhau"
                        name="matKhau"
                        placeholder="Nháº­p máº­t kháº©u"
                        required
                        autocomplete="current-password"
                    >
                </div>

                <div class="form-remember">
                    <label>
                        <input type="checkbox" id="ghinhoPass" name="ghinhoPass">
                        Ghi nhá»› Ä‘Äƒng nháº­p
                    </label>
                    <a href="#" class="forgot-password" onclick="alert('ChÆ°a lÃ m chá»©c nÄƒng quÃªn máº­t kháº©u'); return false;">QuÃªn máº­t kháº©u?</a>
                </div>

                <button type="submit" class="btn-submit">ÄÄƒng Nháº­p</button>
            </form>

            <div class="login-footer">
                ChÆ°a cÃ³ tÃ i khoáº£n? <a href="dangky.html">ÄÄƒng kÃ½ ngay</a>
            </div>
        </div>
    </div>

    <script src="auth-client.js"></script>
    <script>
      (function () {
        var form = document.getElementById("loginForm");
        var msg = document.getElementById("loginMessage");

        function showMsg(text, ok) {
          if (!msg) return;
          msg.style.display = "block";
          msg.style.background = ok ? "rgba(16,185,129,0.12)" : "rgba(239,68,68,0.12)";
          msg.style.color = ok ? "#065f46" : "#7f1d1d";
          msg.style.border = ok ? "1px solid rgba(16,185,129,0.25)" : "1px solid rgba(239,68,68,0.25)";
          msg.textContent = text;
        }

        function getAfterLoginUrl(user) {
          // Æ¯u tiÃªn dÃ¹ng hÃ m má»›i náº¿u báº¡n Ä‘Ã£ thÃªm trong auth-client.js
          if (window.AUTH && typeof AUTH.afterLoginUrl === "function") {
            return AUTH.afterLoginUrl(user);
          }
          // Fallback: náº¿u chÆ°a cÃ³ afterLoginUrl thÃ¬ váº«n vá» index
          return "index.html";
        }

        // Náº¿u Ä‘Ã£ Ä‘Äƒng nháº­p rá»“i => chuyá»ƒn tháº³ng
        try {
          if (window.AUTH && AUTH.getToken && AUTH.getToken()) {
            var u = (AUTH.getUser && AUTH.getUser()) || null;
            window.location.href = getAfterLoginUrl(u);
            return;
          }
        } catch (e) {
          // bá» qua
        }

        if (form) {
          form.addEventListener("submit", async function (e) {
            e.preventDefault();

            var tenDangNhap = document.getElementById("tenDangNhap").value.trim();
            var matKhau = document.getElementById("matKhau").value;
            var remember = !!document.getElementById("ghinhoPass").checked;

            if (!tenDangNhap || !matKhau) {
              showMsg("Vui lÃ²ng nháº­p tÃªn Ä‘Äƒng nháº­p vÃ  máº­t kháº©u.", false);
              return;
            }

            try {
              showMsg("Äang Ä‘Äƒng nháº­p...", true);

              var data = await AUTH.login(tenDangNhap, matKhau, remember);

              showMsg("ÄÄƒng nháº­p thÃ nh cÃ´ng! Äang chuyá»ƒn trang...", true);

              // user cÃ³ thá»ƒ náº±m á»Ÿ data.user hoáº·c data.taiKhoan hoáº·c Ä‘Ã£ Ä‘Æ°á»£c AUTH.saveSession lÆ°u rá»“i
              var user = (data && (data.user || data.taiKhoan)) || (AUTH.getUser && AUTH.getUser()) || null;

              window.location.href = getAfterLoginUrl(user);
            } catch (err) {
              showMsg((err && err.message) ? err.message : "ÄÄƒng nháº­p tháº¥t báº¡i", false);
            }
          });
        }
      })();
    </script>
</body>
</html>
